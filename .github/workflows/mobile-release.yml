name: Mobile Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect Native Changes
    runs-on: ubuntu-latest
    outputs:
      native_changed: ${{ steps.check.outputs.native_changed }}
      is_tag: ${{ steps.check.outputs.is_tag }}
      profile: ${{ steps.check.outputs.profile }}
      channel: ${{ steps.check.outputs.channel }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release type and check for native changes
        id: check
        run: |
          # Check if this is a tag push (Production release)
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "is_tag=true" >> $GITHUB_OUTPUT
            echo "profile=production" >> $GITHUB_OUTPUT
            echo "channel=production" >> $GITHUB_OUTPUT
            # For production tags, always do a full build
            echo "native_changed=true" >> $GITHUB_OUTPUT
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
            echo "profile=preview" >> $GITHUB_OUTPUT
            echo "channel=preview" >> $GITHUB_OUTPUT
            
            # Check for native code changes since last commit
            NATIVE_PATHS="ios/ android/ apps/mobile/ios/ apps/mobile/android/"
            NATIVE_FILES="package.json apps/mobile/package.json app.json apps/mobile/app.json Podfile Gemfile"
            
            NATIVE_CHANGED=false
            
            # Check paths
            for path in $NATIVE_PATHS; do
              if git diff --name-only HEAD~1 HEAD | grep -q "^$path"; then
                NATIVE_CHANGED=true
                break
              fi
            done
            
            # Check specific files that affect native builds
            if [ "$NATIVE_CHANGED" = false ]; then
              for file in $NATIVE_FILES; do
                if git diff --name-only HEAD~1 HEAD | grep -q "^$file$"; then
                  NATIVE_CHANGED=true
                  break
                fi
              done
            fi
            
            echo "native_changed=$NATIVE_CHANGED" >> $GITHUB_OUTPUT
          fi
          
          echo "Detected changes:"
          echo "  is_tag: $(cat $GITHUB_OUTPUT | grep is_tag)"
          echo "  native_changed: $(cat $GITHUB_OUTPUT | grep native_changed)"
          echo "  profile: $(cat $GITHUB_OUTPUT | grep profile)"
          echo "  channel: $(cat $GITHUB_OUTPUT | grep channel)"

  ota-update:
    name: Publish OTA Update
    needs: detect-changes
    if: needs.detect-changes.outputs.native_changed == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Mapbox credentials
        run: |
          # Configure .netrc for Mapbox SDK downloads
          echo "machine api.mapbox.com" >> ~/.netrc
          echo "login mapbox" >> ~/.netrc
          echo "password ${{ secrets.MAPBOX_DOWNLOADS_TOKEN }}" >> ~/.netrc
          chmod 600 ~/.netrc

      - uses: pnpm/action-setup@v2
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Publish OTA update
        working-directory: apps/mobile
        run: |
          eas update --branch ${{ needs.detect-changes.outputs.channel }} \
            --message "${{ github.event.head_commit.message }}" \
            --non-interactive

  native-build:
    name: Native Build
    needs: detect-changes
    if: needs.detect-changes.outputs.native_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Mapbox credentials
        run: |
          # Configure .netrc for Mapbox SDK downloads
          echo "machine api.mapbox.com" >> ~/.netrc
          echo "login mapbox" >> ~/.netrc
          echo "password ${{ secrets.MAPBOX_DOWNLOADS_TOKEN }}" >> ~/.netrc
          chmod 600 ~/.netrc

      - uses: pnpm/action-setup@v2
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build app
        working-directory: apps/mobile
        run: |
          eas build \
            --profile ${{ needs.detect-changes.outputs.profile }} \
            --platform all \
            --non-interactive
