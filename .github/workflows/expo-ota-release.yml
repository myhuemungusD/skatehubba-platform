name: Expo OTA Release (Manual Only)

on:
  workflow_dispatch:
    inputs:
      release_channel:
        description: "Expo release channel"
        required: true
        default: "production"
      message:
        description: "Update message"
        required: true
        default: "OTA update"

concurrency:
  group: expo-ota-release
  cancel-in-progress: false

jobs:
  publish:
    name: Publish OTA Update
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install Expo CLI
        run: npm install -g expo-cli

      - name: Install project dependencies
        run: npm install --legacy-peer-deps

      - name: Configure Expo Authentication
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "‚ùå ERROR: EXPO_TOKEN secret is missing!"
            exit 1
          fi
          echo "üîê Expo token detected. Proceeding‚Ä¶"

      - name: Publish OTA Update to Expo
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "üöÄ Publishing OTA update..."
          expo publish \
            --release-channel "${{ github.event.inputs.release_channel }}" \
            --non-interactive \
            --message "${{ github.event.inputs.message }}"

      - name: Success Output
        run: echo "üéâ OTA update published successfully!"
