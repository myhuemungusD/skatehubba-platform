{"version":3,"file":"wrapServerComponentWithSentry.js","sources":["../../../src/common/wrapServerComponentWithSentry.ts"],"sourcesContent":["import type { RequestEventData } from '@sentry/core';\nimport {\n  captureException,\n  getActiveSpan,\n  getCapturedScopesOnSpan,\n  getRootSpan,\n  handleCallbackErrors,\n  propagationContextFromHeaders,\n  Scope,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n  setCapturedScopesOnSpan,\n  SPAN_STATUS_ERROR,\n  SPAN_STATUS_OK,\n  startSpanManual,\n  vercelWaitUntil,\n  winterCGHeadersToDict,\n  withIsolationScope,\n  withScope,\n} from '@sentry/core';\nimport { isNotFoundNavigationError, isRedirectNavigationError } from '../common/nextNavigationErrorUtils';\nimport type { ServerComponentContext } from '../common/types';\nimport { flushSafelyWithTimeout } from '../common/utils/responseEnd';\nimport { TRANSACTION_ATTR_SENTRY_TRACE_BACKFILL } from './span-attributes-with-logic-attached';\nimport { commonObjectToIsolationScope, commonObjectToPropagationContext } from './utils/tracingUtils';\n\n/**\n * Wraps an `app` directory server component with Sentry error instrumentation.\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function wrapServerComponentWithSentry<F extends (...args: any[]) => any>(\n  appDirComponent: F,\n  context: ServerComponentContext,\n): F {\n  const { componentRoute, componentType } = context;\n  // Even though users may define server components as async functions, for the client bundles\n  // Next.js will turn them into synchronous functions and it will transform any `await`s into instances of the `use`\n  // hook. ðŸ¤¯\n  return new Proxy(appDirComponent, {\n    apply: (originalFunction, thisArg, args) => {\n      const requestTraceId = getActiveSpan()?.spanContext().traceId;\n      const isolationScope = commonObjectToIsolationScope(context.headers);\n\n      const activeSpan = getActiveSpan();\n      if (activeSpan) {\n        const rootSpan = getRootSpan(activeSpan);\n        const { scope } = getCapturedScopesOnSpan(rootSpan);\n        setCapturedScopesOnSpan(rootSpan, scope ?? new Scope(), isolationScope);\n      }\n\n      const headersDict = context.headers ? winterCGHeadersToDict(context.headers) : undefined;\n\n      isolationScope.setSDKProcessingMetadata({\n        normalizedRequest: {\n          headers: headersDict,\n        } satisfies RequestEventData,\n      });\n\n      return withIsolationScope(isolationScope, () => {\n        return withScope(scope => {\n          scope.setTransactionName(`${componentType} Server Component (${componentRoute})`);\n\n          if (process.env.NEXT_RUNTIME === 'edge') {\n            const propagationContext = commonObjectToPropagationContext(\n              context.headers,\n              propagationContextFromHeaders(headersDict?.['sentry-trace'], headersDict?.['baggage']),\n            );\n\n            if (requestTraceId) {\n              propagationContext.traceId = requestTraceId;\n            }\n\n            scope.setPropagationContext(propagationContext);\n          }\n\n          const activeSpan = getActiveSpan();\n          if (activeSpan) {\n            const rootSpan = getRootSpan(activeSpan);\n            const sentryTrace = headersDict?.['sentry-trace'];\n            if (sentryTrace) {\n              rootSpan.setAttribute(TRANSACTION_ATTR_SENTRY_TRACE_BACKFILL, sentryTrace);\n            }\n          }\n\n          return startSpanManual(\n            {\n              op: 'function.nextjs',\n              name: `${componentType} Server Component (${componentRoute})`,\n              attributes: {\n                [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'component',\n                [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.function.nextjs.server_component',\n                'sentry.nextjs.ssr.function.type': componentType,\n                'sentry.nextjs.ssr.function.route': componentRoute,\n              },\n            },\n            span => {\n              return handleCallbackErrors(\n                () => originalFunction.apply(thisArg, args),\n                error => {\n                  // When you read this code you might think: \"Wait a minute, shouldn't we set the status on the root span too?\"\n                  // The answer is: \"No.\" - The status of the root span is determined by whatever status code Next.js decides to put on the response.\n                  if (isNotFoundNavigationError(error)) {\n                    // We don't want to report \"not-found\"s\n                    span.setStatus({ code: SPAN_STATUS_ERROR, message: 'not_found' });\n                  } else if (isRedirectNavigationError(error)) {\n                    // We don't want to report redirects\n                    span.setStatus({ code: SPAN_STATUS_OK });\n                  } else {\n                    span.setStatus({ code: SPAN_STATUS_ERROR, message: 'internal_error' });\n                    captureException(error, {\n                      mechanism: {\n                        handled: false,\n                        type: 'auto.function.nextjs.server_component',\n                      },\n                    });\n                  }\n                },\n                () => {\n                  span.end();\n                  vercelWaitUntil(flushSafelyWithTimeout());\n                },\n              );\n            },\n          );\n        });\n      });\n    },\n  });\n}\n"],"names":[],"mappings":"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"}