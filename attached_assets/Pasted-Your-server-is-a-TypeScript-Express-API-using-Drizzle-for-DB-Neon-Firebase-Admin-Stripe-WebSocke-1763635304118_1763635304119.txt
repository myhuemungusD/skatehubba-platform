Your server is a TypeScript Express API using Drizzle for DB, Neon, Firebase Admin, Stripe, WebSockets, Passport, and AI APIs.

The structure is valid. Nothing is broken syntactically.

But there are a few issues you should clean.

2. Production / Dev Scripts (Important)

Your scripts are fine but missing two things:

A. Cross-platform environment variables

Using:

NODE_ENV=development


only works on Linux/Mac shells.
On Windows (your main machine) it does not work.

Fix: use cross-env.

"dev": "cross-env NODE_ENV=development tsx server/index.ts",
"start": "cross-env NODE_ENV=production node dist/server/index.js"


Add:

npm i -D cross-env

B. Your build script
"build": "node scripts/build-server.mjs"


Make sure you actually have this file:

apps/server/scripts/build-server.mjs


Inside it needs to run something like:

import { build } from "esbuild";

await build({
  entryPoints: ["server/index.ts"],
  outfile: "dist/server/index.js",
  bundle: true,
  platform: "node",
  target: "node20",
  format: "esm"
});


If this file is missing, your build fails.

3. Dependency Issues
A. You have crypto listed

Remove this:

"crypto": "^1.0.1"


Node.js already includes crypto built-in.
Installing it from npm causes runtime and type issues.

B. You are mixing CommonJS and ESM

You set:

"type": "module"


This is correct (modern ESM), but then your main points to index.js.

You MUST ensure:

your TypeScript output is ESM

your dist/server/index.js uses import syntax

no CommonJS files remain in builds

If Drizzle, Firebase Admin, or Passport plugins break because they expect CommonJS, you fix this in your build config.

C. Express Session + Neon

You are using:

connect-pg-simple
express-session
@neondatabase/serverless


Neon serverless does not support pg sessions easily because it drops idle connections.

If you deploy this server on Vercel or Cloudflare, rethink session strategy.

Use: JWT, Firebase session cookies, or Supabase/Prisma-style auth.

4. Drizzle / DB Tasks

Your DB scripts are correct:

"db:push": "drizzle-kit push"
"db:studio": "drizzle-kit studio"


But be sure your root drizzle.config.ts declares:

import { defineConfig } from "drizzle-kit";

export default defineConfig({
  schema: "./packages/db/schema/index.ts",
  out: "./migrations",
  driver: "pg",
  dbCredentials: {
    connectionString: process.env.DATABASE_URL
  }
});


If not, these commands will fail.

5. Firebase Admin

You depend on:

firebase-admin": "^13.4.0"


Make sure you are not loading service account JSON directly in the repo.
Load credentials from environment variables.

Example:

import admin from "firebase-admin";

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(JSON.parse(process.env.FIREBASE_ADMIN_JSON)),
  });
}

6. AI Dependencies

You have both:

"@google/generative-ai"
"openai"


This is fine. Just avoid loading both clients on every request.
Initialize once and memoize.

7. WebSocket + Express

You have:

"ws": "^8.18.0"


Make sure your entry point stitches the server properly:

const server = http.createServer(app);
const wss = new WebSocket.Server({ server });
server.listen(PORT);


Avoid creating WebSocket server on a different port inside monorepo.

8. Security Dependencies

You already have:

helmet
compression
rate-limit
cookie-parser
validator


These are correct for a production API.

But you should also add CORS allowlist so your apps (web, mobile, admin, studio) arenâ€™t blocked.

9. Recommended Cleaned-Up Version

Here is the improved package.json with fixes:

{
  "name": "@skatehubba/server",
  "version": "1.0.0",
  "private": true,
  "description": "SkateHubba Express API server",
  "main": "dist/server/index.js",
  "type": "module",
  "scripts": {
    "start": "cross-env NODE_ENV=production node dist/server/index.js",
    "dev": "cross-env NODE_ENV=development tsx server/index.ts",
    "build": "node scripts/build-server.mjs",
    "db:push": "drizzle-kit push",
    "db:studio": "drizzle-kit studio",
    "check": "tsc --noEmit"
  },
  "dependencies": {
    "@skatehubba/db": "workspace:*",
    "@google/generative-ai": "^0.24.1",
    "@neondatabase/serverless": "^0.9.5",
    "bcryptjs": "^3.0.2",
    "compression": "^1.8.1",
    "connect-pg-simple": "^9.0.1",
    "cookie-parser": "^1.4.7",
    "cors": "^2.8.5",
    "date-fns": "^3.6.0",
    "drizzle-orm": "^0.33.0",
    "drizzle-zod": "^0.5.1",
    "express": "^4.21.2",
    "express-rate-limit": "^7.5.1",
    "express-session": "^1.18.0",
    "firebase-admin": "^13.4.0",
    "helmet": "^7.2.0",
    "jsonwebtoken": "^9.0.2",
    "memoizee": "^0.4.17",
    "nodemailer": "^6.10.1",
    "openai": "^4.56.0",
    "openid-client": "^6.8.1",
    "passport": "^0.7.0",
    "passport-openidconnect": "^0.1.2",
    "pino-http": "^10.5.0",
    "resend": "^6.0.2",
    "rimraf": "^6.0.1",
    "sirv": "^3.0.1",
    "sitemap": "^8.0.0",
    "stripe": "^16.8.0",
    "validator": "^13.12.0",
    "ws": "^8.18.0",
    "zod": "^3.25.76"
  },
  "devDependencies": {
    "cross-env": "^7.0.3",
    "@types/bcryptjs": "^2.4.6",
    "@types/compression": "^1.8.1",
    "@types/cookie-parser": "^1.4.9",
    "@types/cors": "^2.8.19",
    "@types/express": "^4.17.23",
    "@types/express-session": "^1.18.0",
    "@types/jsonwebtoken": "^9.0.10",
    "@types/memoizee": "^0.4.12",
    "@types/node": "^20.14.15",
    "@types/nodemailer": "^6.4.19",
    "@types/passport": "^1.0.16",
    "@types/pg": "^8.11.6",
    "@types/validator": "^13.12.0",
    "@types/ws": "^8.5.12",
    "drizzle-kit": "^0.24.2",
    "tsx": "^4.20.6",
    "typescript": "^5.9.2"
  }