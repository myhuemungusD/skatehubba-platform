Goal: Fully working protected /api/profile endpoint + client test
(Weâ€™ll have this live in <15 minutes)
Step 1 â€” Server side: Create the protected profile route
File: apps/server/server/routes/profile.ts (create if missing)
TypeScriptimport { Router } from "express";
import { admin } from "../firebase"; // your firebase-admin instance
import { db } from "@skatehubba/db";
import { users } from "@skatehubba/db/schema";
import { eq } from "drizzle-orm";

const router = Router();

// Middleware to verify Firebase ID token
async function requireAuth(req, res, next) {
  const authHeader = req.headers.authorization;
  if (!authHeader?.startsWith("Bearer ")) {
    return res.status(401).json({ error: "No token provided" });
  }

  const idToken = authHeader.split("Bearer ")[1];

  try {
    const decodedToken = await admin.auth().verifyIdToken(idToken);
    req.user = decodedToken; // uid, email, etc.
    next();
  } catch (error) {
    return res.status(401).json({ error: "Invalid or expired token" });
  }
}

router.get("/profile", requireAuth, async (req, res) => {
  const { uid } = req.user;

  let user = await db.select().from(users).where(eq(users.id, uid)).get();

  // Auto-create profile on first login if missing (optional but recommended)
  if (!user) {
    const newUser = {
      id: uid,
      email: req.user.email ?? null,
      displayName: req.user.name ?? req.user.email?.split("@")[0] ?? "Skater",
      photoURL: req.user.picture ?? null,
      createdAt: new Date(),
      updatedAt: new Date(),
    };
    await db.insert(users).values(newUser);
    user = newUser;
  }

  return res.json({ user });
});

export default router;
Mount it in your main server file (server/index.ts or app.ts):
TypeScriptimport profileRouter from "./routes/profile";
app.use("/api", profileRouter);
Step 2 â€” Client side (apps/web): Call the protected endpoint
Example using TanStack Query (you already have it):
tsx// apps/web/src/hooks/useProfile.ts
import { useQuery } from "@tanstack/react-query";
import { getAuth } from "firebase/auth";

const API_URL = import.meta.env.VITE_API_URL || "";

export function useProfile() {
  return useQuery({
    queryKey: ["profile"],
    queryFn: async () => {
      const token = await getAuth().currentUser?.getIdToken();
      if (!token) throw new Error("Not authenticated");

      const res = await fetch(`${API_URL}/api/profile`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!res.ok) throw new Error("Failed to fetch profile");
      return res.json();
    },
    staleTime: 5 * 60 * 1000, // 5 minutes
  });
}
Usage in any component:
tsxfunction Profile() {
  const { data, isLoading } = useProfile();
  if (isLoading) return <div>Loadingâ€¦</div>;
  return <div>Hello {data.user.displayName} ðŸ‘‹</div>;
}
Step 3 â€” Test it right now

Run pnpm run dev:all
Open the web app (localhost:3000 or whatever Vite shows)
Sign in with Firebase Auth (Google works instantly)
Open /profile page or any component using useProfile()