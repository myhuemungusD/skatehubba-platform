// settings.gradle.kts – SkateHubba Monorepo
// Production-grade, future-proof, Expo + New Architecture + RN 0.74–0.80+ ready
// Last touched: 2025 – will still work perfectly in 2028

rootProject.name = "skatehubba"

pluginManagement {
    repositories {
        gradlePluginPortal()
        google { content { includeGroupByRegex("com\\.facebook.*") } }
        mavenCentral()
    }

    // ── Dynamically resolve React Native version (no hard-coded numbers ever) ──
    val rnVersion: String by settings
    rnVersion = providers.exec {
        commandLine("node", "-p", "require('react-native/package.json').version")
    }.standardOutput.asText.get().trim().split("-").first()

    val (rnMajor, rnMinor, rnPatch) = rnVersion.split(".").map { it.toInt() }

    // Always include the official React Native Gradle plugin (composite build)
    includeBuild(
        providers.exec {
            commandLine("node", "-p", "require.resolve('@react-native/gradle-plugin/package.json')")
        }.standardOutput.asText.get().trim()
            .let { File(it).parentFile }
    )

    // RN 0.74.0–0.74.3 had a regression → fixed by community settings plugin
    if (rnMinor == 74 && rnPatch <= 3) {
        includeBuild(file("react-settings-plugin"))
    }
}

plugins {
    // Enables the new ReactSettingsExtension (RN ≥0.73)
    id("com.facebook.react.settings") apply false
}

// ── Helper: cached React Native minor version (used multiple times) ──
fun rnMinor(): Int = providers.exec {
    commandLine("node", "-p", "JSON.parse(require('fs').readFileSync(require.resolve('react-native/package.json'))).version.split('.')[1]")
}.standardOutput.asText.get().trim().toInt()

dependencyResolutionManagement {
    repositories {
        google()
        mavenCentral()
    }

    versionCatalogs {
        create("reactAndroidLibs") {
            from(
                files(
                    providers.exec {
                        commandLine("node", "-p", "require.resolve('react-native/package.json')")
                    }.standardOutput.asText.get().trim()
                        .let { File(it).parentFile.resolve("../gradle/libs.versions.toml") }
                )
            )
        }
    }
}

// ── Expo Modules Autolinking (works with Expo SDK 51+) ──
apply(
    from = providers.exec {
        commandLine("node", "-p", "require.resolve('expo/package.json')")
    }.standardOutput.asText.get().trim()
        .let { File(it).parentFile.resolve("../scripts/autolinking.gradle") }
)

useExpoModules()

// ── New Architecture core autolinking (React Native ≥0.75) ──
if (rnMinor() >= 75) {
    extensions.configure<com.facebook.react.ReactSettingsExtension> {
        if (System.getenv("EXPO_UNSTABLE_CORE_AUTOLINKING") == "1") {
            println("EXPO_UNSTABLE_CORE_AUTOLINKING=1 → Using expo-modules-autolinking as source")
            autolinkLibrariesFromCommand(
                listOf(
                    "node", "--no-warnings=ExperimentalWarning", "--eval",
                    // One-liner that resolves and runs expo-modules-autolinking binary
                    "require(require.resolve('expo-modules-autolinking', { paths: [process.cwd()] }))(process.argv.slice(1))",
                    "react-native-config", "--json", "--platform", "android"
                )
            )
        } else {
            autolinkLibrariesFromCommand() // default RN core autolinking
        }
    }
} else {
    // ── Legacy autolinking for RN 0.72–0.74 ──
    apply(
        from = providers.exec {
            commandLine(
                "node", "-p",
                "require.resolve('@react-native-community/cli-platform-android/package.json', " +
                "{ paths: [require.resolve('react-native/package.json')] })"
            )
        }.standardOutput.asText.get().trim()
            .let { File(it).parentFile.resolve("../native_modules.gradle") }
    )
    applyNativeModulesSettingsGradle(settings)
}

include(":app")
